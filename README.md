# CS_Revision_More

### 怎么实现故障检测？
心跳检测技术。采用定时发送一个数据包，如果机器一定时间没响应，就认为是发生故障，自动切换到热备的机器上去。

### 怎么实现主备自动切换？
虚拟IP技术。虚拟IP，就是一个未分配给真实主机的IP，也就是说对外提供数据库服务器的主机除了有一个真实IP外还有一个虚IP，使用这两个IP中的任意一个都可以连接到这台主机，所有项目中数据库链接一项配置的都是这个虚IP，当服务器发生故障无法对外提供服务时，动态将这个虚IP切换到备用主机。

其实现原理主要是靠 TCP/IP 的 ARP 协议。因为IP地址只是一个逻辑地址，在以太网中 MAC 地址才是真正用来进行数据传输的物理地址，每台主机中都有一个 ARP 高速缓存，存储同一个网络内的 IP 地址与 MAC 地址的对应关系，以太网中的主机发送数据时会先从这个缓存中查询目标 IP 对应的 MAC 地址，会向这个 MAC 地址发送数据。操作系统会自动维护这个缓存。这就是整个实现的关键，比如下面这个 ARP 缓存示例：

```
(192.168.1.219) at 00:21:5A:DB:68:E8 [ether] on bond0
(192.168.1.217) at 00:21:5A:DB:68:E8 [ether] on bond0
(192.168.1.218) at 00:21:5A:DB:7F:C2 [ether] on bond0
```

其中，192.168.1.217、192.168.1.218 是两台真实的电脑，192.168.1.217 为对外提供数据库服务的主机，192.168.1.218 为热备的机器，192.168.1.219 为虚IP，注意219、217的 MAC 地址是相同的。当 218 发现 217 宕机后会向网络发送一个 ARP 数据包，告诉所有主机 192.168.1.219 这个IP对应的MAC地址是 00:21:5A:DB:7F:C2，这样所有发送到 219 的数据包都会发送到 MAC 地址为 00:21:5A:DB:7F:C2 的机器，也就是 218 的机器。

### Ref
[Virtual IP](https://cloud.tencent.com/developer/article/1639566)
